#!/usr/bin/env python3

import sys
import os
import platform
import json
import requests
import subprocess
from tempfile import NamedTemporaryFile

def get_python_version():
    return f"{sys.version_info.major}.{sys.version_info.minor}"

def is_windows():
    return platform.system().lower() == "windows"

def get_architecture():
    machine = platform.machine().lower()
    if is_windows():
        if machine == "amd64" or machine == "x86_64":
            return "win_amd64"
        elif machine == "x86" or machine == "i386":
            return "win32"
        elif machine == "arm64" or machine == "aarch64":
            return "win_arm64"
    return machine

def get_wheel_url(python_version):
    wheels_json_url = "https://github.com/celray/python-gdal-installer/blob/main/gdal-wheels.json"
    response = requests.get(wheels_json_url)
    wheels = response.json()
    
    arch = get_architecture()
    version_wheels = wheels.get(python_version, {})
    return version_wheels.get(arch)

def main():
    if is_windows():
        python_version = get_python_version()
        wheel_url = get_wheel_url(python_version)
        
        if not wheel_url:
            print(f"No GDAL wheel found for Python {python_version} on {get_architecture()}")
            sys.exit(1)
        
        # Download and install wheel
        response = requests.get(wheel_url)
        with NamedTemporaryFile(suffix='.whl', delete=False) as tmp_file:
            tmp_file.write(response.content)
            wheel_path = tmp_file.name
        
        subprocess.check_call([sys.executable, "-m", "pip", "install", wheel_path])
        os.unlink(wheel_path)
    else:
        # On Unix systems, just use pip
        subprocess.check_call([sys.executable, "-m", "pip", "install", "GDAL"])

if __name__ == "__main__":
    main()
